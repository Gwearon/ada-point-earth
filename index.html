<head>
    <!-- <script src="/lib/globe.gl.min.js"></script> -->
    <link rel="stylesheet" href="/css/main.css">
    <script src="/lib/tap.js"></script>
    <script src="/lib/globe.gl.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>

<body style="position: relative;">

    <button id="menu-click-target" class="mdl-button mdl-js-button"></button>
    <div id="menu-popup" class="mdl-menu mdl-js-menu mdl-menu--bottom-left" for="menu-click-target">
        <ul>
        </ul>
    </div>

    <div id="globe">
    </div>

    <div id="snackbar" class="mdl-js-snackbar mdl-snackbar">
        <div class="mdl-snackbar__text"></div>
        <button class="mdl-snackbar__action" type="button"></button>
    </div>

    <script>
        const initialization = ([pools, contryPolygons, populatedPlaces]) => {
            const menu = document.querySelector('#menu-click-target')
            const menuItems = document.querySelector('#menu-popup')
            const snackbar = document.querySelector('#snackbar')

            const poolColor = 'rgba(255, 255, 0, 0.8)'
            const cityColor = '#eeeeee'
            const clickPoolSelectionRadius = 50

            const duplicatedRelays = {}
            pools = pools.filter(pool => {
                const key = [pool.meta.ticker, pool.geo.lat, pool.geo.long].join('_')
                if (!duplicatedRelays[key]) {
                    duplicatedRelays[key] = 1
                    return true
                }
                duplicatedRelays[key]++
                return false
            })

            const lPoolData = pools.map(pool => {
                return {
                    text: '',
                    lat: pool.geo.lat,
                    long: pool.geo.long,
                    size: 0.6,
                    dotRadius: 0.3,
                    color: poolColor,
                    altitude: 0.006,
                    type: 'pool'
                }
            })

            const lPopulatedPlacesData = populatedPlaces.features.map(populatedPlace => {
                return {
                    text: populatedPlace.properties.name,
                    lat: populatedPlace.properties.latitude,
                    long: populatedPlace.properties.longitude,
                    size: 0.4,
                    dotRadius: 0.2,
                    color: cityColor,
                    altitude: 0.0055,
                    type: 'country'
                }
            })

            const lData = lPoolData.concat(lPopulatedPlacesData);

            const globe = Globe({ waitForGlobeReady: true })(document.getElementById('globe'))
                .globeImageUrl('/img/earth-blue-marble.jpg')
                .backgroundImageUrl('/img/night-sky.png')
                .bumpImageUrl('/img/earth-topology.png')

                .labelsData(lData)
                .labelLat('lat')
                .labelLng('long')
                .labelText('text')
                .labelSize('size')
                .labelDotRadius('dotRadius')
                .labelColor('color')
                .labelResolution(2)
                .labelAltitude(0.0055)

                .polygonsData(contryPolygons.features)
                .polygonCapColor(() => 'rgba(200, 0, 0, 0.0)')
                .polygonSideColor(() => 'rgba(150, 150, 150, 0.4)')
                .polygonStrokeColor(() => '#aaaaaa')
                .polygonAltitude(0.005)
                // .polygonLabel(({ properties: d }) => `
                //     <b>${d.ADMIN} (${d.ISO_A2}):</b> <br />
                //     GDP: <i>${d.GDP_MD_EST}</i> M$<br/>
                //     Population: <i>${d.POP_EST}</i>
                //     `)

            const globeDOM = document.getElementById('globe')

            Tappable(globeDOM)
            globeDOM.addEventListener('tap', event => {
                const pos = globe.toGlobeCoords(event.detail.clientX, event.detail.clientY)
                if (pos === null) {
                    return
                }
                pos.long = pos.lng
                delete pos.lng

                const menuItemsUl = menuItems.querySelector('ul')
                menuItemsUl.innerHTML = ''
                const poolsRadius = pools.filter(pool => haversineDistance(pool.geo, pos) < clickPoolSelectionRadius)

                poolsRadius.forEach(pool => {
                        const poolLi = document.createElement('li')
                        poolLi.classList = 'mdl-menu__item'
                        poolLi.textContent = pool.meta.ticker
                        menuItemsUl.appendChild(poolLi)
                        console.log(pool.meta)
                    })

                if (!poolsRadius.length) {
                    var data = {
                        message: 'No pools in radius',
                        timeout: 2000,
                        actionHandler: function() {},
                        actionText: 'Ok'
                    }
                    snackbar.MaterialSnackbar.showSnackbar(data)
                    return
                }

                const maxPageX = window.pageXOffset + window.innerWidth;
                const maxPageY = window.pageYOffset + window.innerHeight;
                const availableHeight = maxPageY - (globeDOM.offsetTop + event.detail.clientY);
                const availableWidth = maxPageX - (globeDOM.offsetLeft + event.detail.clientX);

                setTimeout(() => {
                    console.log(availableWidth, menuItems.offsetWidth, window.innerWidth, event.detail.clientX)
                    const top = event.detail.clientY - (availableHeight < menuItems.offsetHeight ? menuItems.offsetHeight + 5 : -5)
                    const left = event.detail.clientX - (availableWidth < menuItems.offsetWidth ? menuItems.offsetWidth + 5 : -5)
                    menu.style.top = top + 'px';
                    menu.style.left = left + 'px';
                    menu.click()
                }, 0)
            })

            globeDOM.addEventListener('dragging', event => {
                menuItems.MaterialMenu.hide()
            })

            const controls = globe.controls()

            globeDOM.addEventListener('mousedown', () => {
                controls.autoRotate = false
            })
            controls.autoRotate = true
            controls.enableKeys = true

            function haversineDistance(coords1, coords2) {
                const toRad = x => {
                    return x * Math.PI / 180;
                }

                const lon1 = coords1.lat;
                const lat1 = coords1.long;

                const lon2 = coords2.lat;
                const lat2 = coords2.long;

                const R = 6371; // km

                const x1 = lat2 - lat1;
                const dLat = toRad(x1);
                const x2 = lon2 - lon1;
                const dLon = toRad(x2)
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const d = R * c;

                return d;
            }
        }

        Promise.all([
            window.fetch('relays/augmentedPools.json').then(res => res.json()),
            window.fetch('geodata/countryPolygons.json').then(res => res.json()),
            window.fetch('geodata/populatedPlaces.json').then(res => res.json())
        ]).then(initialization)
    </script>
</body>