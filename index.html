<head>
    <style>
        body {
            margin: 0;
        }
    </style>
    <!-- <script src="/lib/globe.gl.min.js"></script> -->
    <script src="/lib/tap.js"></script>
    <script src="/lib/globe.gl.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>

<body style="position: relative;">
    <button id="menu-pools" style="position: absolute; color: white; z-index: 1; visibility: hidden; pointer-events:none;" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">more_vert</i>
    </button>
    <ul class="mdl-menu mdl-js-menu" style="overflow: scroll; max-height: 300px" for="menu-pools">
    </ul>

    <div id="globe">
    </div>

    <script>
        const initialization = ([pools, contryPolygons, populatedPlaces]) => {
            const menu = document.querySelector('#menu-pools')
            const menuItems = document.querySelector('.mdl-menu');

            const poolColor = 'rgba(255, 255, 0, 0.8)'
            const poolColorHover = 'rgba(255, 0, 0, 0.8)'
            const cityColor = '#eeeeee'

            const lPoolData = pools.map(pool => {
                return {
                    text: '',
                    lat: pool.geo.lat,
                    long: pool.geo.long,
                    size: 0.6,
                    dotRadius: 0.3,
                    color: poolColor,
                    colorHover: poolColorHover,
                    altitude: 0.006,
                    type: 'pool'
                }
            })

            const lPopulatedPlacesData = populatedPlaces.features.map(populatedPlace => {
                return {
                    text: populatedPlace.properties.name,
                    lat: populatedPlace.properties.latitude,
                    long: populatedPlace.properties.longitude,
                    size: 0.4,
                    dotRadius: 0.2,
                    color: cityColor,
                    colorHover: cityColor,
                    altitude: 0.0055,
                    type: 'country'
                }
            })

            const lData = lPoolData.concat(lPopulatedPlacesData);

            const globe = Globe({ waitForGlobeReady: true })(document.getElementById('globe'))
                .globeImageUrl('/img/earth-blue-marble.jpg')
                .backgroundImageUrl('/img/night-sky.png')
                .bumpImageUrl('/img/earth-topology.png')

                .labelsData(lData)
                .labelLat('lat')
                .labelLng('long')
                .labelText('text')
                .labelSize('size')
                .labelDotRadius('dotRadius')
                .labelColor('color') //'rgba(255, 165, 0, 0.75)')
                .labelResolution(2)
                .labelAltitude(0.0055)

                .polygonsData(contryPolygons.features)
                .polygonCapColor(() => 'rgba(200, 0, 0, 0.0)')
                .polygonSideColor(() => 'rgba(150, 150, 150, 0.4)')
                .polygonStrokeColor(() => '#aaaaaa')
                .polygonAltitude(0.005)
                // .onPolygonClick(onFeatureClick)

                // .polygonLabel(({ properties: d }) => `
                //     <b>${d.ADMIN} (${d.ISO_A2}):</b> <br />
                //     GDP: <i>${d.GDP_MD_EST}</i> M$<br/>
                //     Population: <i>${d.POP_EST}</i>
                //     `)

            const globeDOM = document.getElementById('globe')

            Tappable(globeDOM)
            globeDOM.addEventListener('tap', event => {
                const pos = globe.toGlobeCoords(event.detail.clientX, event.detail.clientY)
                if (pos === null) {
                    return
                }
                pos.long = pos.lng
                delete pos.lng

                menuItems.innerHTML = ''
                pools.filter(pool => haversineDistance(pool.geo, pos) < 50) // 50km distance
                    .forEach(pool => {
                        const poolLi = document.createElement('li')
                        poolLi.classList = 'mdl-menu__item'
                        poolLi.textContent = pool.meta.ticker
                        menuItems.appendChild(poolLi)
                        console.log(pool.meta.ticker)
                    })

                menu.style.top = (event.detail.clientY - 30) + 'px';
                menu.style.left = (event.detail.clientX) + 'px';
                menu.click()
            })

            globeDOM.addEventListener('dragging', event => {
                menuItems.MaterialMenu.hide()
            })

            const controls = globe.controls()

            globeDOM.addEventListener('mousedown', () => {
                controls.autoRotate = false
            })
            controls.autoRotate = true
            controls.enableKeys = true

            function haversineDistance(coords1, coords2) {
                const toRad = x => {
                    return x * Math.PI / 180;
                }

                const lon1 = coords1.lat;
                const lat1 = coords1.long;

                const lon2 = coords2.lat;
                const lat2 = coords2.long;

                const R = 6371; // km

                const x1 = lat2 - lat1;
                const dLat = toRad(x1);
                const x2 = lon2 - lon1;
                const dLon = toRad(x2)
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const d = R * c;

                return d;
            }
        }

        Promise.all([
            window.fetch('mainetRelays/augmentedPools.json').then(res => res.json()),
            window.fetch('geodata/countryPolygons.json').then(res => res.json()),
            window.fetch('geodata/populatedPlaces.json').then(res => res.json())
        ]).then(initialization)
    </script>
</body>